
<div id='messages'>
  <% @pod.messages.each do |m| %>
    <p>
    <span class='name'><%= m.user.name %></span>
    <span class='body'><%= m.text_body %></span>
    </p>
  <% end %>
</div>

<form id='message-form' role='role'>
  <div class='form-group'>
    <input type='text' class='form-control' id='message-body' placeholder='Message body'/>
  </div>
 <button type="submit" class="btn btn-default">Submit</button>
</form>

<script>

(function() {
  <% url = root_url.gsub(/https?:\/\//, "") %>
  var dispatcher = new WebSocketRails('<%= url %>/websocket');

  dispatcher.on_open = function(data) {
    console.log('Connection has been established: ', data);
    // You can trigger new server events inside this callback if you wish.
  }


  var channel = dispatcher.subscribe_private('pod_<%= @pod.id %>');
  channel.on_success = function(resp) {
    console.log('channel', resp);
  };

  var $messages = $('#messages');

  // listen on the channel
  channel.bind('messages.created', function(data) {
    addMessage(data);
  });

  // send on the event router
  $form = $('#message-form');
  $input = $form.find('#message-body');

  $form.submit(function(evt) {
    evt.preventDefault();

    var data = {
      pod_id: <%= @pod.id %>,
      text_body: $input.val(),
      name: '<%= current_user.name %>',
    }

    dispatcher.trigger('messages.create', data, function(response) {
      console.log('success', response);
    }, function(response) {
      console.log('fail', response);
    });

    //channel.trigger('messages.created', data);
  })

  function getColor(name) {
    var sum = 0;
    for (var i = 0; i < name.length - 1; i++) {
      sum += name.charCodeAt(i);
    }

    var h = sum % 16 * 16, s = 78 + name.length % 20 - 10, b = 30 + name.length % 10 - 5;
    var color = tinycolor({h: h, s: s, l: b});
    return color.toHexString();

  }

  function addMessage(data) {
    var color = getColor(data.name);
    $messages.append(
        "<p>"
        + "<span class='name' style='color:" + color + ";'>" + data.name + "</span>"
        + "<span class='body'>" + data.text_body + "</span>"
        + "</p>"
        );
  }

}());
</script>
